<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lucky Jet + Мины Сигналы</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

  <!-- ГЛАВНОЕ МЕНЮ -->
  <div id="menu">
    <h1>СИГНАЛЫ 2025</h1>
    <button class="game-btn" onclick="openLuckyJet()">Lucky Jet</button>
    <button class="game-btn" onclick="openMines()">Мины</button>
  </div>

  <!-- LUCKY JET -->
  <div id="luckyjet" class="game-screen hidden">
    <div id="preview" onclick="document.getElementById('lucky-game').classList.remove('hidden'); this.classList.add('hidden')">
      <img src="assets/preview.png" alt="Lucky Jet">
      <div class="play-btn">ИГРАТЬ</div>
    </div>

    <div id="lucky-game" class="hidden">
      <img id="game-bg" src="assets/background.jpg">
      <div id="stars"></div>
      <div id="clouds"></div>
      <div id="header-title"><img src="assets/luckyjet_text.svg"></div>
      <div id="preloader"><img src="assets/preloader.svg" class="loader"><p>Загрузка...</p></div>
      <div id="center-orbit">
        <div id="multiplier">x1.00</div>
        <div id="jetman-container">
          <img id="jetman" src="assets/jetman.png">
          <img id="fire" src="assets/jetpack_fire.svg">
        </div>
      </div>
      <button id="get-signal" onclick="generateLuckySignal()">ПОЛУЧИТЬ СИГНАЛ</button>
    </div>
  </div>

  <!-- МИНЫ — полностью автоматический режим с твоей SVG-сеткой -->
  <div id="mines" class="game-screen hidden">
    <div class="mines-header">
      <button class="back" onclick="backToMenu()">Назад</button>
      <h2>Мины — Автосигнал</h2>
    </div>

    <div id="mines-field">
      <object type="image/svg+xml" data="assets/mines/grid.svg" id="mines-svg"></object>
    </div>

    <div class="mines-panel">
      <div class="mines-count">
        <span>Мин:</span>
        <div class="count-btns">
          <button onclick="setMines(1)" class="active">1</button>
          <button onclick="setMines(3)">3</button>
          <button onclick="setMines(5)">5</button>
          <button onclick="setMines(10)">10</button>
          <button onclick="setMines(20)">20</button>
        </div>
      </div>

      <div class="mines-info">
        <div>Кэф: <span id="coeff">1.00</span>x</div>
        <div>Открыто: <span id="opened">0</span>/25</div>
      </div>

      <button id="signal-btn" onclick="getMinesSignal()">ПОЛУЧИТЬ СИГНАЛ</button>
    </div>
  </div>

  <script>
    Telegram?.WebApp?.ready();
    Telegram?.WebApp?.expand();

    // === ГЛОБАЛЬНЫЕ ===
    const FIRST_LUCKY_COEFF = 4.20;
    let luckyIsFirst = true;
    let luckyCanGetSignal = true;

    let minesCount = 1;
    let minesField = [];
    let minesOpened = 0;
    let minesActive = false;
    let svgDoc = null;

    // === ДОСТУП К SVG ===
    document.getElementById('mines-svg').addEventListener('load', () => {
      svgDoc = document.getElementById('mines-svg').contentDocument;
    });

    // === МЕНЮ ===
    function openLuckyJet() { hideAll(); document.getElementById('luckyjet').classList.remove('hidden'); }
    function openMines()    { hideAll(); document.getElementById('mines').classList.remove('hidden'); }
    function backToMenu()   { hideAll(); document.getElementById('menu').classList.remove('hidden'); }
    function hideAll() { document.querySelectorAll('.game-screen, #menu').forEach(el => el.classList.add('hidden')); }

    // === LUCKY JET СИГНАЛ ===
    function generateLuckySignal() {
      if (!luckyCanGetSignal) return;
      luckyCanGetSignal = false;
      const btn = document.getElementById('get-signal');
      btn.textContent = "Проверка... 30"; btn.disabled = true;

      let sec = 30;
      const timer = setInterval(() => {
        sec--;
        btn.textContent = `Проверка... ${sec}`;
        if (sec <= 0) { clearInterval(timer); btn.textContent = "ПОЛУЧИТЬ СИГНАЛ"; btn.disabled = false; luckyCanGetSignal = true; }
      }, 1000);

      setTimeout(() => {
        const coeff = luckyIsFirst ? FIRST_LUCKY_COEFF : (Math.random() * 7 + 1.1).toFixed(2);
        luckyIsFirst = false;
        document.getElementById('multiplier').textContent = `x${coeff}`;
        Telegram?.WebApp?.showAlert(`СИГНАЛ x${coeff}\nСтавь быстро — улёт 100%`);
        Telegram?.WebApp?.HapticFeedback?.impactOccurred('heavy');
      }, 1500);
    }

    // === МИНЫ ===
    function setMines(n) {
      minesCount = n;
      document.querySelectorAll('.count-btns button').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
    }

    function getMinesSignal() {
      if (minesActive) return;

      minesActive = true;
      minesOpened = 0;
      document.getElementById('coeff').textContent = '1.00';
      document.getElementById('opened').textContent = '0';
      document.getElementById('signal-btn').textContent = 'Сигнал...';
      document.getElementById('signal-btn').disabled = true;

      // Скрываем все звёзды
      if (svgDoc) for (let i = 1; i <= 25; i++) {
        const star = svgDoc.getElementById(`star-${i}`);
        if (star) star.setAttribute('opacity', '0');
      }

      // Генерируем поле
      minesField = Array(25).fill('star');
      for (let i = 0; i < minesCount; i++) {
        minesField[24 - i] = 'bomb'; // бомбы в конце
      }

      // Сколько откроем безопасных
      const safeCount = 25 - minesCount;
      const openCount = Math.max(10, Math.floor(safeCount * 0.92));

      // Перемешиваем безопасные индексы
      const safeIndices = [];
      for (let i = 0; i < 25; i++) if (minesField[i] === 'star') safeIndices.push(i);
      for (let i = safeIndices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [safeIndices[i], safeIndices[j]] = [safeIndices[j], safeIndices[i]];
      }

      // Открываем с анимацией
      let opened = 0;
      const interval = setInterval(() => {
        if (opened >= openCount) {
          clearInterval(interval);
          const finalCoeff = (1 + opened * 0.15).toFixed(2);
          document.getElementById('coeff').textContent = finalCoeff;
          document.getElementById('opened').textContent = opened;

          setTimeout(() => {
            Telegram?.WebApp?.showAlert(`СИГНАЛ ГОТОВ!\nОткрыто ${opened} звёзд\nКоэффициент: x${finalCoeff}\n\n100% профит — ставь сейчас!`);
            Telegram?.WebApp?.HapticFeedback?.impactOccurred('heavy');
            document.getElementById('signal-btn').textContent = 'НОВЫЙ СИГНАЛ';
            document.getElementById('signal-btn').disabled = false;
            minesActive = false;
          }, 600);
          return;
        }

        const idx = safeIndices[opened];
        if (svgDoc) {
          const star = svgDoc.getElementById(`star-${idx + 1}`);
          if (star) star.setAttribute('opacity', '1');
        }

        minesOpened++;
        document.getElementById('opened').textContent = minesOpened;
        document.getElementById('coeff').textContent = (1 + minesOpened * 0.15).toFixed(2);
        opened++;
      }, 170);
    }
  </script>
</body>
</html>
